# =============================================================================
# Deployment com Foco em Readiness Probe - Controle de Tráfego
# =============================================================================
# A Readiness Probe controla se o Pod recebe tráfego do Service:
# - Probe OK → Pod adicionado ao Service (recebe requests)
# - Probe FALHA → Pod removido do Service (não recebe requests)
#
# Diferente da Liveness, a Readiness NÃO reinicia o container!
# Use para: dependências externas, warmup, manutenção temporária
# =============================================================================

apiVersion: apps/v1
kind: Deployment

metadata:
  name: demo-api-readiness
  namespace: demo
  labels:
    app.kubernetes.io/name: demo-api-readiness
    app.kubernetes.io/component: api

spec:
  # Múltiplas réplicas para demonstrar tráfego sendo roteado
  replicas: 3

  selector:
    matchLabels:
      app.kubernetes.io/name: demo-api-readiness

  template:
    metadata:
      labels:
        app.kubernetes.io/name: demo-api-readiness

    spec:
      containers:
        - name: demo-api
          image: demo-api:v1
          imagePullPolicy: Never

          ports:
            - name: http
              containerPort: 3000
              protocol: TCP

          envFrom:
            - configMapRef:
                name: demo-api-config
            - secretRef:
                name: demo-api-secret

          # Startup Probe básica
          startupProbe:
            httpGet:
              path: /health
              port: http
            failureThreshold: 10
            periodSeconds: 5

          # ================================================================
          # READINESS PROBE DETALHADA
          # ================================================================
          # Esta probe deve verificar se a aplicação está PRONTA para
          # receber tráfego, não apenas se está viva.
          #
          # O endpoint /ready pode verificar:
          # - Conexão com banco de dados
          # - Conexão com cache (Redis)
          # - Conexão com serviços externos
          # - Warmup de dados em memória
          #
          # Se qualquer dependência falhar:
          # → Readiness retorna erro
          # → Pod é removido do Service
          # → Tráfego vai para outros pods saudáveis
          # ================================================================
          readinessProbe:
            httpGet:
              # Endpoint específico de readiness
              # Diferente de /health, verifica dependências
              path: /ready
              port: http
            # Tempo antes da primeira verificação
            # Permite warmup inicial
            initialDelaySeconds: 5
            # Intervalo curto para detectar problemas rapidamente
            periodSeconds: 5
            # Timeout para verificação de dependências
            # Pode ser maior se verificar serviços externos
            timeoutSeconds: 5
            # Apenas 1 sucesso para voltar a receber tráfego
            successThreshold: 1
            # 2 falhas = 10 segundos para ser removido do Service
            # Valor baixo para resposta rápida a problemas
            failureThreshold: 2

          # Liveness básica (não verifica dependências)
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 10
            periodSeconds: 15
            timeoutSeconds: 3
            failureThreshold: 3

          resources:
            requests:
              cpu: "100m"
              memory: "128Mi"
            limits:
              cpu: "500m"
              memory: "512Mi"

      terminationGracePeriodSeconds: 30
      restartPolicy: Always
